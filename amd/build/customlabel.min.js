define(["jquery","core/config","core/str","core/log"],function(a,b,c,d){var e={strs:[],context:[],init:function(b){e.context=b;var f=[{key:"changetypeadvice",component:"customlabel"}];c.get_strings(f).done(function(a){e.strs=a}),a(".customctl").bind("click",this.togglecustom),a(".customctl-string").bind("click",this.togglecustomstring),a(".customlabel-constraint").bind("click",this.constraint_colorize),a("select.constrained").bind("change",this.applyconstraints),a("select.constrained").prop("disabled",null),a("#id_labelclass").bind("change",this.typechangesubmit),a("#id_level0").trigger("change"),a("#id_level1").trigger("change"),a("#id_level2").trigger("change"),d.debug("AMD Customlabels initialized")},rebindconstraints:function(){a("select.constrained").off("change"),a("select.constrained").bind("change",this.applyconstraints),d.debug("AMD Customlabels constraints rebound")},togglecustom:function(){var c=a(this),d=c.attr("id").replace("customctl-","custom-thumb-"),e=c.attr("id").replace("customctl-","custom-");a("#"+e).hasClass("hidden")?(a("#"+e).removeClass("hidden"),a("#"+d).removeClass("hidden"),c.attr("src",b.wwwroot+"/mod/customlabel/pix/plus.gif")):(a("#"+e).addClass("hidden"),a("#"+d).addClass("hidden"),c.attr("src",b.wwwroot+"/mod/customlabel/pix/minus.gif"))},togglecustomstring:function(){var b=a(this),c=b.attr("id").replace("customctl-","custom-"),d=b.attr("data").split(",");a("#"+c).hasClass("hidden")?(a("#"+c).removeClass("hidden"),b.html(d[1])):(a("#"+c).addClass("hidden"),b.html(d[2]))},constraint_colorize:function(){var b=a(this);1==b.val()?this.addclass("green"):this.addclass("red")},applyconstraints:function(){var c=a(this),f=c.attr("data-constraints"),g=c.attr("data-label-type"),h=c.attr("data-cmid");d.debug("Applying constraints on "+c.attr("id"));var i=0;if(""===f)return void d.debug("No targets ");var j=f.split(","),k=[],l=a("#"+c.attr("id")+" option");l.each(function(){a(this).prop("selected")&&k.push(a(this).val())});var m=k.join(","),n=[],o=[],p=[],q=function(){n[i].push(a(this).val()),o[j[r]].push(a(this).val())};for(var r in j){o[j[r]]=[];var s="level"+j[r];n[i]=s,p.push(a("#id_"+s).first()),i++,n[i]=[];var t=a("#id_"+s+" option:selected");t.each(q),i++}a.each(p,function(a,b){b.prop("disabled",!0)});var u=encodeURIComponent(JSON.stringify(n)),v=b.wwwroot+"/mod/customlabel/ajax/applyconstraints.php?";v+="selector="+c.attr("name"),v+="&targets="+f,v+="&type="+g,v+="&cmid="+h,v+="&constraints="+m,v+="&selection="+u,a.get(v,"",function(b){var c=b,d=f.split(",");for(var g in d)if(c[d[g]]){var h='<input type="hidden" name="level'+d[g];h+='" value="_qf__force_multiselect_submission">',h+=c[d[g]],a("#fitem_id_level"+d[g]+" .felement.fselect").html(h)}e.rebindconstraints();for(var i in o){var j=o[i][0];j>0&&a("#id_level"+i+" option[value="+j+"]").attr("selected",!0)}a(".select.constrained").prop("disabled",!1)},"json")},typechangesubmit:function(){var c,d=a(this);confirm(e.strs[0])&&(e.context.updatelabelid?(c=b.wwwroot+"/mod/customlabel/mod.php?",c+="update="+e.context.updatelabelid,c+="&sesskey="+b.sesskey,c+="&sr="+e.context.section,c+="&returntomod="+e.context.returntomod,c+="&type="+d.val()):(c=b.wwwroot+"/course/mod.php?",c+="id="+e.context.courseid,c+="&section="+e.context.section,c+="&sesskey="+b.sesskey,c+="&add=customlabel",c+="&returntomod="+e.context.returntomod,c+="&type="+d.val()),document.location.href=c)}};return e});