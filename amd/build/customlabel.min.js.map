{"version":3,"sources":["../src/customlabel.js"],"names":["define","$","cfg","str","log","customlabel","strs","context","init","params","get_strings","key","component","done","s","bind","togglecustom","togglecustomstring","constraint_colorize","applyconstraints","prop","typechangesubmit","trigger","debug","rebindconstraints","off","that","customthumbid","attr","replace","customid","hasClass","removeClass","wwwroot","addClass","parts","split","html","val","addclass","targets","labeltype","cmid","i","targetsarr","selectedopts","sourceseloptions","each","push","optionstring","join","selectedtargetopts","targetvalues","targetelms","extractvalues","target","targetname","first","targetseloptions","index","value","formvaluestring","encodeURIComponent","JSON","stringify","url","get","data","selectors","levelid","selectvalue","confirm","updatelabelid","courseid","section","sesskey","returntomod","document","location","href"],"mappings":"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","sourcesContent":["/*\n *\n */\n// jshint unused:false, undef:false\n\ndefine(['jquery', 'core/config', 'core/str', 'core/log'], function($, cfg, str, log) {\n\n    var customlabel = {\n\n        strs: [],\n\n        context: [],\n\n        init: function(params) {\n\n            customlabel.context = params;\n\n            // Call strings.\n            var stringdefs = [\n                {key: 'changetypeadvice', component: 'customlabel'}, // 0\n            ];\n\n            str.get_strings(stringdefs).done(function(s) {\n                customlabel.strs = s;\n            });\n\n            $('.customctl').bind('click', this.togglecustom);\n            $('.customctl-string').bind('click', this.togglecustomstring);\n            $('.customlabel-constraint').bind('click', this.constraint_colorize);\n            $('select.constrained').bind('change', this.applyconstraints);\n            $('select.constrained').prop('disabled', null);\n            $('#id_labelclass').bind('change', this.typechangesubmit);\n\n            // Trigg the first classifier after loading\n            $('#id_level0').trigger('change');\n            $('#id_level1').trigger('change');\n            $('#id_level2').trigger('change');\n\n            log.debug(\"AMD Customlabels initialized\");\n        },\n\n        rebindconstraints: function() {\n            $('select.constrained').off('change');\n            $('select.constrained').bind('change', this.applyconstraints);\n            log.debug(\"AMD Customlabels constraints rebound\");\n        },\n\n        togglecustom: function() {\n\n            var that = $(this);\n\n            var customthumbid = that.attr('id').replace('customctl-', 'custom-thumb-');\n            var customid = that.attr('id').replace('customctl-', 'custom-');\n\n            if ($('#' + customid).hasClass('hidden')) {\n                $('#' + customid).removeClass('hidden');\n                $('#' + customthumbid).removeClass('hidden');\n                that.attr('src', cfg.wwwroot + '/mod/customlabel/pix/plus.gif');\n            } else {\n                $('#' + customid).addClass('hidden');\n                $('#' + customthumbid).addClass('hidden');\n                that.attr('src', cfg.wwwroot + '/mod/customlabel/pix/minus.gif');\n            }\n        },\n\n        togglecustomstring: function() {\n\n            var that = $(this);\n            var customid = that.attr('id').replace('customctl-', 'custom-');\n            var parts = that.attr('data').split(',');\n\n            if ($('#' + customid).hasClass('hidden')) {\n                $('#' + customid).removeClass('hidden');\n                that.html(parts[1]);\n            } else {\n                $('#' + customid).addClass('hidden');\n                that.html(parts[2]);\n            }\n        },\n\n        constraint_colorize: function() {\n            var that = $(this);\n\n            if (that.val() == 1) {\n                this.addclass('green');\n            } else {\n                this.addclass('red');\n            }\n        },\n\n        applyconstraints: function() {\n\n            var that = $(this);\n            var targets = that.attr('data-constraints');\n            var labeltype = that.attr('data-label-type');\n            var cmid = that.attr('data-cmid');\n\n            log.debug(\"Applying constraints on \" + that.attr('id'));\n\n            var i = 0;\n\n            if (targets === '') {\n                log.debug(\"No targets \");\n                return;\n            }\n            var targetsarr = targets.split(',');\n\n            var selectedopts = [];\n\n            // Get constraints in activated select.\n            var sourceseloptions = $('#' + that.attr('id') + \" option\");\n            sourceseloptions.each(function() {\n                if ($(this).prop('selected')) {\n                    selectedopts.push($(this).val());\n                }\n            });\n\n            var optionstring = selectedopts.join(',');\n\n            // Get selection constraints in targets select.\n            var selectedtargetopts = [];\n            var targetvalues = [];\n            var targetelms = [];\n\n            var extractvalues = function() {\n                selectedtargetopts[i].push($(this).val());\n                targetvalues[targetsarr[target]].push($(this).val());\n            };\n\n            for (var target in targetsarr) {\n                targetvalues[targetsarr[target]] = [];\n                var targetname = 'level' + targetsarr[target];\n                selectedtargetopts[i] = targetname;\n                targetelms.push($('#id_' + targetname).first());\n                i++;\n                selectedtargetopts[i] = [];\n\n                var targetseloptions = $('#id_' + targetname + \" option:selected\");\n                targetseloptions.each(extractvalues);\n\n                i++;\n            }\n\n            // Invalidate targets waiting for constraints resolution. Do not invalidate if mothing selected.\n            $.each(targetelms, function(index, value) {\n                value.prop('disabled', true);\n            });\n\n            var formvaluestring = encodeURIComponent(JSON.stringify(selectedtargetopts));\n\n            var url = cfg.wwwroot + \"/mod/customlabel/ajax/applyconstraints.php?\";\n            url += \"selector=\" + that.attr('name');\n            url += \"&targets=\" + targets;\n            url += \"&type=\" + labeltype;\n            url += \"&cmid=\" + cmid;\n            url += \"&constraints=\" + optionstring;\n            url += '&selection=' + formvaluestring;\n\n            $.get(url, '', function(data) {\n                // var selectors = JSON.parse(data);\n                var selectors = data;\n\n                var targetsarr = targets.split(',');\n\n                // Dispatch in selectors.\n                for (var target in targetsarr) {\n                    if (selectors[targetsarr[target]]) {\n                        var str = '<input type=\"hidden\" name=\"level' + targetsarr[target];\n                        str += '\" value=\"_qf__force_multiselect_submission\">';\n                        str += selectors[targetsarr[target]];\n                        $('#fitem_id_level' + targetsarr[target] + ' .felement.fselect').html(str);\n                    }\n                }\n                customlabel.rebindconstraints();\n\n                // Finish by reselecting what was initially selected.\n                for (var levelid in targetvalues) {\n                    var selectvalue = targetvalues[levelid][0];\n                    if (selectvalue > 0) {\n                        $('#id_level' + levelid + \" option[value=\" + selectvalue + \"]\").attr(\"selected\", true);\n                    }\n                }\n                $('.select.constrained').prop('disabled', false);\n\n            }, 'json');\n        },\n\n        typechangesubmit: function() {\n\n            var that = $(this);\n            var url;\n\n            if (confirm(customlabel.strs[0])) {\n                if (!customlabel.context.updatelabelid) {\n                    url = cfg.wwwroot + '/course/mod.php?';\n                    url += 'id=' + customlabel.context.courseid;\n                    url += '&section=' + customlabel.context.section;\n                    url += '&sesskey=' + cfg.sesskey;\n                    url += '&add=customlabel';\n                    url += '&returntomod=' + customlabel.context.returntomod;\n                    url += '&type=' + that.val();\n                } else {\n                    url = cfg.wwwroot + '/mod/customlabel/mod.php?';\n                    url += 'update=' + customlabel.context.updatelabelid;\n                    url += '&sesskey=' + cfg.sesskey;\n                    url += '&sr=' + customlabel.context.section;\n                    url += '&returntomod=' + customlabel.context.returntomod;\n                    url += '&type=' + that.val();\n                }\n                document.location.href = url;\n            }\n        }\n    };\n\n    return customlabel;\n});\n"],"file":"customlabel.min.js"}