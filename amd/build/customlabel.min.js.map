{"version":3,"file":"customlabel.min.js","sources":["../src/customlabel.js"],"sourcesContent":["/*\n *\n */\n// jshint unused:false, undef:false\n\ndefine(['jquery', 'core/config', 'core/str', 'core/log'], function($, cfg, str, log) {\n\n    var customlabel = {\n\n        strs: [],\n\n        context: [],\n\n        init: function(params) {\n\n            customlabel.context = params;\n\n            // Call strings.\n            var stringdefs = [\n                {key: 'changetypeadvice', component: 'customlabel'}, // 0\n            ];\n\n            str.get_strings(stringdefs).done(function(s) {\n                customlabel.strs = s;\n            });\n\n            $('.customctl').bind('click', this.togglecustom);\n            $('.customctl-string').bind('click', this.togglecustomstring);\n            $('.customlabel-constraint').bind('click', this.constraint_colorize);\n            $('.mform').on('change', 'select[data-constrained = \"1\"]', this.applyconstraints);\n            $('select[data-constrained = \"1\"]').prop('disabled', null);\n            $('#id_labelclass').bind('change', this.typechangesubmit);\n\n            // Trigg the first classifier after loading\n            $('#id_level0').trigger('change');\n            $('#id_level1').trigger('change');\n            $('#id_level2').trigger('change');\n\n            log.debug(\"AMD Customlabels initialized\");\n        },\n\n        /*\n        rebindconstraints: function() {\n            $('select[data-constrained = \"1\"]').off('change');\n            $('select[data-constrained = \"1\"]').bind('change', this.applyconstraints);\n            log.debug(\"AMD Customlabels constraints rebound\");\n        },\n        */\n\n        togglecustom: function() {\n\n            var that = $(this);\n\n            var customthumbid = that.attr('id').replace('customctl-', 'custom-thumb-');\n            var customid = that.attr('id').replace('customctl-', 'custom-');\n\n            if ($('#' + customid).hasClass('hidden')) {\n                $('#' + customid).removeClass('hidden');\n                $('#' + customthumbid).removeClass('hidden');\n                that.attr('src', cfg.wwwroot + '/mod/customlabel/pix/plus.gif');\n            } else {\n                $('#' + customid).addClass('hidden');\n                $('#' + customthumbid).addClass('hidden');\n                that.attr('src', cfg.wwwroot + '/mod/customlabel/pix/minus.gif');\n            }\n        },\n\n        togglecustomstring: function() {\n\n            var that = $(this);\n            var customid = that.attr('id').replace('customctl-', 'custom-');\n            var parts = that.attr('data-labels').split(',');\n\n            if ($('#' + customid).hasClass('hidden')) {\n                $('#' + customid).removeClass('hidden');\n                that.html(parts[1]);\n            } else {\n                $('#' + customid).addClass('hidden');\n                that.html(parts[2]);\n            }\n        },\n\n        constraint_colorize: function() {\n            var that = $(this);\n\n            if (that.val() == 1) {\n                this.addclass('green');\n            } else {\n                this.addclass('red');\n            }\n        },\n\n        applyconstraints: function() {\n\n            var that = $(this);\n            var targets = that.attr('data-constraints');\n            var labeltype = that.attr('data-label-type');\n            var cmid = that.attr('data-cmid');\n\n            log.debug(\"Applying constraints on \" + that.attr('id'));\n\n            var i = 0;\n\n            if (targets === '') {\n                log.debug(\"No targets \");\n                return;\n            }\n            var targetsarr = targets.split(',');\n\n            var selectedopts = [];\n\n            // Get constraints in activated select.\n            var sourceseloptions = $('#' + that.attr('id') + \" option\");\n            sourceseloptions.each(function() {\n                if ($(this).prop('selected')) {\n                    selectedopts.push($(this).val());\n                }\n            });\n\n            var optionstring = selectedopts.join(',');\n\n            // Get selection constraints in targets select.\n            var selectedtargetopts = [];\n            var targetvalues = [];\n            var targetelms = [];\n\n            var extractvalues = function() {\n                selectedtargetopts[i].push($(this).val());\n                targetvalues[targetsarr[target]].push($(this).val());\n            };\n\n            for (var target in targetsarr) {\n                targetvalues[targetsarr[target]] = [];\n                var targetname = 'level' + targetsarr[target];\n                selectedtargetopts[i] = targetname;\n                targetelms.push($('#id_' + targetname).first());\n                i++;\n                selectedtargetopts[i] = [];\n\n                var targetseloptions = $('#id_' + targetname + \" option:selected\");\n                targetseloptions.each(extractvalues);\n\n                i++;\n            }\n\n            // Invalidate targets waiting for constraints resolution. Do not invalidate if mothing selected.\n            $.each(targetelms, function(index, value) {\n                value.prop('disabled', true);\n            });\n\n            var formvaluestring = encodeURIComponent(JSON.stringify(selectedtargetopts));\n\n            var url = cfg.wwwroot + \"/mod/customlabel/ajax/applyconstraints.php?\";\n            url += \"selector=\" + that.attr('name');\n            url += \"&targets=\" + targets;\n            url += \"&type=\" + labeltype;\n            url += \"&cmid=\" + cmid;\n            url += \"&constraints=\" + optionstring;\n            url += '&selection=' + formvaluestring;\n\n            $.get(url, '', function(data) {\n                // var selectors = JSON.parse(data);\n                var selectors = data;\n\n                var targetsarr = targets.split(',');\n\n                // Dispatch in selectors.\n                for (var target in targetsarr) {\n                    if (selectors[targetsarr[target]]) {\n                        var str = '<input type=\"hidden\" name=\"level' + targetsarr[target];\n                        str += '\" value=\"_qf__force_multiselect_submission\">';\n                        str += selectors[targetsarr[target]];\n                        log.debug('Rewriting select ' + '#fitem_id_level' + targetsarr[target] + ' .felement');\n                        $('#fitem_id_level' + targetsarr[target] + ' .felement').html(str);\n                    }\n                }\n                // customlabel.rebindconstraints();\n\n                // Finish by reselecting what was initially selected.\n                for (var levelid in targetvalues) {\n                    var selectvalue = targetvalues[levelid][0];\n                    if (selectvalue > 0) {\n                        $('#id_level' + levelid + \" option[value=\" + selectvalue + \"]\").attr(\"selected\", true);\n                    }\n                }\n                $('select[data-constrained = \"1\"]').prop('disabled', false);\n\n            }, 'json');\n        },\n\n        typechangesubmit: function() {\n\n            var that = $(this);\n            var url;\n\n            if (confirm(customlabel.strs[0])) {\n                if (!customlabel.context.updatelabelid) {\n                    url = cfg.wwwroot + '/course/mod.php?';\n                    url += 'id=' + customlabel.context.courseid;\n                    url += '&section=' + customlabel.context.section;\n                    url += '&sesskey=' + cfg.sesskey;\n                    url += '&add=customlabel';\n                    url += '&returntomod=' + customlabel.context.returntomod;\n                    url += '&type=' + that.val();\n                } else {\n                    url = cfg.wwwroot + '/mod/customlabel/mod.php?';\n                    url += 'update=' + customlabel.context.updatelabelid;\n                    url += '&sesskey=' + cfg.sesskey;\n                    url += '&sr=' + customlabel.context.section;\n                    url += '&returntomod=' + customlabel.context.returntomod;\n                    url += '&type=' + that.val();\n                }\n                document.location.href = url;\n            }\n        }\n    };\n\n    return customlabel;\n});\n"],"names":["define","$","cfg","str","log","customlabel","strs","context","init","params","get_strings","key","component","done","s","bind","this","togglecustom","togglecustomstring","constraint_colorize","on","applyconstraints","prop","typechangesubmit","trigger","debug","that","customthumbid","attr","replace","customid","hasClass","removeClass","wwwroot","addClass","parts","split","html","val","addclass","targets","labeltype","cmid","i","targetsarr","selectedopts","each","push","optionstring","join","selectedtargetopts","targetvalues","targetelms","extractvalues","target","targetname","first","index","value","formvaluestring","encodeURIComponent","JSON","stringify","url","get","data","selectors","levelid","selectvalue","confirm","updatelabelid","sesskey","section","returntomod","courseid","document","location","href"],"mappings":"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"}