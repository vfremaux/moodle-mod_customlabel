{"version":3,"file":"customlabel.min.js","sources":["../src/customlabel.js"],"sourcesContent":["/*\n *\n */\n// jshint unused:false, undef:false\n\ndefine(['jquery', 'core/config', 'core/str', 'core/log'], function($, cfg, str, log) {\n\n    var customlabel = {\n\n        strs: [],\n\n        context: [],\n\n        init: function(params) {\n\n            customlabel.context = params;\n\n            // Call strings.\n            var stringdefs = [\n                {key: 'changetypeadvice', component: 'customlabel'}, // 0\n            ];\n\n            str.get_strings(stringdefs).done(function(s) {\n                customlabel.strs = s;\n            });\n\n            $('.customctl').bind('click', this.togglecustom);\n            $('.customctl-string').bind('click', this.togglecustomstring);\n            $('.customlabel-constraint').bind('click', this.constraint_colorize);\n            $('select.constrained').bind('change', this.applyconstraints);\n            $('select.constrained').prop('disabled', null);\n            $('#id_labelclass').bind('change', this.typechangesubmit);\n\n            // Trigg the first classifier after loading\n            $('#id_level0').trigger('change');\n            $('#id_level1').trigger('change');\n            $('#id_level2').trigger('change');\n\n            log.debug(\"AMD Customlabels initialized\");\n        },\n\n        rebindconstraints: function() {\n            $('select.constrained').off('change');\n            $('select.constrained').bind('change', this.applyconstraints);\n            log.debug(\"AMD Customlabels constraints rebound\");\n        },\n\n        togglecustom: function() {\n\n            var that = $(this);\n\n            var customthumbid = that.attr('id').replace('customctl-', 'custom-thumb-');\n            var customid = that.attr('id').replace('customctl-', 'custom-');\n\n            if ($('#' + customid).hasClass('hidden')) {\n                $('#' + customid).removeClass('hidden');\n                $('#' + customthumbid).removeClass('hidden');\n                that.attr('src', cfg.wwwroot + '/mod/customlabel/pix/plus.gif');\n            } else {\n                $('#' + customid).addClass('hidden');\n                $('#' + customthumbid).addClass('hidden');\n                that.attr('src', cfg.wwwroot + '/mod/customlabel/pix/minus.gif');\n            }\n        },\n\n        togglecustomstring: function() {\n\n            var that = $(this);\n            var customid = that.attr('id').replace('customctl-', 'custom-');\n            var parts = that.attr('data-labels').split(',');\n\n            if ($('#' + customid).hasClass('hidden')) {\n                $('#' + customid).removeClass('hidden');\n                that.html(parts[1]);\n            } else {\n                $('#' + customid).addClass('hidden');\n                that.html(parts[2]);\n            }\n        },\n\n        constraint_colorize: function() {\n            var that = $(this);\n\n            if (that.val() == 1) {\n                this.addclass('green');\n            } else {\n                this.addclass('red');\n            }\n        },\n\n        applyconstraints: function() {\n\n            var that = $(this);\n            var targets = that.attr('data-constraints');\n            var labeltype = that.attr('data-label-type');\n            var cmid = that.attr('data-cmid');\n\n            log.debug(\"Applying constraints on \" + that.attr('id'));\n\n            var i = 0;\n\n            if (targets === '') {\n                log.debug(\"No targets \");\n                return;\n            }\n            var targetsarr = targets.split(',');\n\n            var selectedopts = [];\n\n            // Get constraints in activated select.\n            var sourceseloptions = $('#' + that.attr('id') + \" option\");\n            sourceseloptions.each(function() {\n                if ($(this).prop('selected')) {\n                    selectedopts.push($(this).val());\n                }\n            });\n\n            var optionstring = selectedopts.join(',');\n\n            // Get selection constraints in targets select.\n            var selectedtargetopts = [];\n            var targetvalues = [];\n            var targetelms = [];\n\n            var extractvalues = function() {\n                selectedtargetopts[i].push($(this).val());\n                targetvalues[targetsarr[target]].push($(this).val());\n            };\n\n            for (var target in targetsarr) {\n                targetvalues[targetsarr[target]] = [];\n                var targetname = 'level' + targetsarr[target];\n                selectedtargetopts[i] = targetname;\n                targetelms.push($('#id_' + targetname).first());\n                i++;\n                selectedtargetopts[i] = [];\n\n                var targetseloptions = $('#id_' + targetname + \" option:selected\");\n                targetseloptions.each(extractvalues);\n\n                i++;\n            }\n\n            // Invalidate targets waiting for constraints resolution. Do not invalidate if mothing selected.\n            $.each(targetelms, function(index, value) {\n                value.prop('disabled', true);\n            });\n\n            var formvaluestring = encodeURIComponent(JSON.stringify(selectedtargetopts));\n\n            var url = cfg.wwwroot + \"/mod/customlabel/ajax/applyconstraints.php?\";\n            url += \"selector=\" + that.attr('name');\n            url += \"&targets=\" + targets;\n            url += \"&type=\" + labeltype;\n            url += \"&cmid=\" + cmid;\n            url += \"&constraints=\" + optionstring;\n            url += '&selection=' + formvaluestring;\n\n            $.get(url, '', function(data) {\n                // var selectors = JSON.parse(data);\n                var selectors = data;\n\n                var targetsarr = targets.split(',');\n\n                // Dispatch in selectors.\n                for (var target in targetsarr) {\n                    if (selectors[targetsarr[target]]) {\n                        var str = '<input type=\"hidden\" name=\"level' + targetsarr[target];\n                        str += '\" value=\"_qf__force_multiselect_submission\">';\n                        str += selectors[targetsarr[target]];\n                        $('#fitem_id_level' + targetsarr[target] + ' .felement.fselect').html(str);\n                    }\n                }\n                customlabel.rebindconstraints();\n\n                // Finish by reselecting what was initially selected.\n                for (var levelid in targetvalues) {\n                    var selectvalue = targetvalues[levelid][0];\n                    if (selectvalue > 0) {\n                        $('#id_level' + levelid + \" option[value=\" + selectvalue + \"]\").attr(\"selected\", true);\n                    }\n                }\n                $('select.constrained').prop('disabled', false);\n\n            }, 'json');\n        },\n\n        typechangesubmit: function() {\n\n            var that = $(this);\n            var url;\n\n            if (confirm(customlabel.strs[0])) {\n                if (!customlabel.context.updatelabelid) {\n                    url = cfg.wwwroot + '/course/mod.php?';\n                    url += 'id=' + customlabel.context.courseid;\n                    url += '&section=' + customlabel.context.section;\n                    url += '&sesskey=' + cfg.sesskey;\n                    url += '&add=customlabel';\n                    url += '&returntomod=' + customlabel.context.returntomod;\n                    url += '&type=' + that.val();\n                } else {\n                    url = cfg.wwwroot + '/mod/customlabel/mod.php?';\n                    url += 'update=' + customlabel.context.updatelabelid;\n                    url += '&sesskey=' + cfg.sesskey;\n                    url += '&sr=' + customlabel.context.section;\n                    url += '&returntomod=' + customlabel.context.returntomod;\n                    url += '&type=' + that.val();\n                }\n                document.location.href = url;\n            }\n        }\n    };\n\n    return customlabel;\n});\n"],"names":["define","$","cfg","str","log","customlabel","strs","context","init","params","get_strings","key","component","done","s","bind","this","togglecustom","togglecustomstring","constraint_colorize","applyconstraints","prop","typechangesubmit","trigger","debug","rebindconstraints","off","that","customthumbid","attr","replace","customid","hasClass","removeClass","wwwroot","addClass","parts","split","html","val","addclass","targets","labeltype","cmid","i","targetsarr","selectedopts","each","push","optionstring","join","selectedtargetopts","targetvalues","targetelms","extractvalues","target","targetname","first","index","value","formvaluestring","encodeURIComponent","JSON","stringify","url","get","data","selectors","levelid","selectvalue","confirm","updatelabelid","sesskey","section","returntomod","courseid","document","location","href"],"mappings":"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"}